## 整体流程
### 解析⽤户研究需求  
通过最多五轮问答，明确研究⽬标、研究对象、使⽤的⽂献范围与输出形式（综述/报告等） 

+ 研究层⾯：明确研究边界、防⽌后续⽆限检索 / ⽆限写作
+ 系统职责： 将⾃然语⾔需求 → 结构化 Research Task （不进⼊任何检索或写作  ）
+ 是否接口化：否

### ⽣成初始研究结构（Research Plan）  
根据研究⽬标⽣成⼀个合理的综述结构，结构数量受控

+ 研究层⾯：这是“假设性结构”允许后续失败和收缩 
+ 系统职责 ：⽣成 章节级 / 问题级结构，记录为可修改对象 
+ 是否接口化：否

### 拆分为⼦研究⽬标（Sub-goals） 
将结构节点转化为可检索的研究意图

+ 研究层⾯：⼦⽬标是信息需求，不是写作指令
+ 系统职责：⽣成 Sub-goal 对象，每个⼦⽬标独⽴⽣命周期
+ 是否接⼝化：是  

### 重新生成单个子研究目标
+ 研究层⾯：按照原本检索目标重新生成更为宽泛的表达方式
+ 系统职责：补充步骤5、6的证据不足情况
+ 是否接⼝化：是  

###  ⼦⽬标驱动检索（仅检索，不写作）  
+ 研究层⾯：
    - 在指定的知识空间（仅限上传⽂献）中进⾏语义检索 
    - 检索⽬标是 收集证据内容（chunk / 段落） 
    - 不⽣成总结性⽂字、不输出 AI 结论 
    - 将检索结果放⼊该⼦⽬标的「证据池」 
    - 如果检索结果少于预期标准使用步骤4生成更为宽泛的研究目标，最大轮次为2次 
    - 关于本地知识库检索方式，探讨了两种多级检索策略：一种是先按段落切分并检索相似片段，再判断是否整篇文档相关；另一种是对整篇文章先做总结，用总结内容进行向量化比较，提高检索效率与准确性。
+ 系统职责：为后续撰写检索所需要的信息 chunk
+ 是否接⼝化：是  

###  证据评估与结构调整  
+ 研究层⾯：
    - 证据充分：⼦⽬标保留，进⼊后续写作阶段
    - 证据部分充分：⼦⽬标降级（弱化表述）或与相邻⽬标合并，使用步骤4生成更为宽泛的研究目标，最大轮次为2次 
    - 多轮检索仍不⾜： 删除该⼦⽬标
    - 若多个关键⼦⽬标⽆法⽀撑： 判定为结构性失败，仅对研究结构进⾏⼀次简化调整  
+ 系统职责：完善整体证据池

###  分段受约束写作  
+ 对每⼀个保留的⼦⽬标：
    - 仅基于其证据池内容⽣成对应段落
    - 不引⼊外部知识或未检索到的观点  
+ 系统职责： 将evidence转换为context、⽣成单段⽂本  
+ 是否接⼝化：否

###  全局整合与⻛格统⼀ 
+ 研究层⾯：不引⼊新事实，只做组织与润⾊
+ 系统职责：合并段落、做⻛格⼀致化  
+ 是否接⼝化：否

###  ⽣成最终研究综述   
## 所需模块（可即插即用）
#### LLM模块
包括LLM模型调用与接口适配（adapter），用于兼容不同模型的调用接口

#### 数据库查询模块
---

##### 文档处理
 文档解析与文本抽取  

+ PDF / Word / PPT：提取正文文本、标题层级、页码等结构信息。
+ HTML / Markdown：去除样式与脚本，保留语义标签（标题、列表、代码块）。
+ Excel / CSV：按 Sheet / 表格结构抽取，保留表头与单元格关系。
+ 图片 / 扫描件：通过 OCR 转换为可编辑文本。

文本规范化与清洗（Normalization）

+ 统一字符编码（UTF-8）
+ 清除无语义内容：页眉、页脚、页码、重复水印
+ 统一标点、空白符、换行规则
+ 保留必要的结构标识（如标题、列表、代码块）

原始文件与中间结果存储（Storage）

+ **原始文件**
    - 存储于对象存储（如 MinIO），用于回溯与重处理。
+ **解析后的结构化文本**
    - 存储为 JSON / 数据库记录，作为 chunk 切分的直接输入。
+ 保证原始文件、结构化文本、后续 chunk 之间可一一关联。

---

#####  文本切分（Chunking）策略  
+ **按结构优先切分**：优先根据章节标题和自然段落进行切分，保持语义完整。
+ **长度控制**：每个 chunk 最大不超过 **600 tokens**，避免超出 embedding 模型输入限制。
+ **重叠窗口**：相邻 chunk 保留约 **100 tokens** 的重叠，防止关键信息被切断。
+ **保留标题信息**：在每个 chunk 中包含所属章节或小节标题，增强语义上下文。
+ **句子级兜底**：当段落过长无法满足长度限制时，按句子进一步切分。

---

##### embedding与reranker模型
推荐选择 bge-m3、E5、GTE，其中 bge-m3专为rag设计，效果更好。rerank也可以采用这三类模型以保持更加稳定的判断。

---

##### 数据库查询
包括关键词数据库查询以及向量数据库查询，共同组合成为最后的结果。

+ 关键词检索可选用ES、PG、SQLite，其中ES性能相对较好（ragflow默认查询使用的就是ES）BM25方式
+ 向量数据库可选择使用ES、FAISS、infinity等，其中faiss仅支持向量查询es功能较为完善成熟，但性能略逊于faiss与infinity

查询数据库选择组合建议：

+ ES：可直接完成向量与关键词查询，功能完善，自己就可以完成混合检索
+ ES + FAISS：ES完成关键词查询、FAISS完成向量查询，合在一起做混合检索

---

初期使用ragflow进行完成数据库查询模块功能

#### 权限管理
使用数据库存储用户权限，每次查询时先到数据库中查询用户拥有的知识库权限

👉 详细的设计规划与后续工作请参见 [TODO.md](./TODO.md)
